<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baaz Bike — Meeting Rooms</title>
  <style>
    :root{
      --brand-orange:#ff6a00;
      --muted:#6b7280;
      --card-bg:#fff;
      --ok-green:#065f46;
      --danger:#7a1b1b;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    body{
      margin:0;
      padding:18px;
      background:linear-gradient(180deg,#fff,#fbfbfb);
      color:#0b0b0b;
      -webkit-font-smoothing:antialiased;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }

    /* BRAND GROUP */
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }

    /* PNG LOGO */
    /* CLEAN LOGO — no box, no background */
   .logo{
     width:52px;
     height:52px;
     border-radius:0;        /* remove rounding */
     background:none !important;
     display:flex;
     align-items:center;
     justify-content:center;
     overflow:visible;       
     box-shadow:none !important;  
     border:none !important; 
     padding:0;
    }

/* CLEAN LOGO — no box, no background */
.logo{
  width:52px;
  height:52px;
  border-radius:0;        /* remove rounding */
  background:none !important;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:visible;       /* PNG बाहर भी दिख सके */
  box-shadow:none !important;  /* remove shadow */
  border:none !important;      /* no border */
  padding:0;
}

/* PNG should look perfect on TV */
.logo-img{
  width:100%;
  height:100%;
  object-fit:contain;
  filter: drop-shadow(0 0 2px rgba(255,255,255,0.9)); 
}


    .brand h1{ margin:0; font-size:18px; font-weight:700; }
    .brand p{ margin:0; font-size:12px; color:var(--muted); font-weight:600; }

    /* Controls: only Book Now + clock */
    #controls{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    .btn{
      background:var(--brand-orange);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 8px 18px rgba(255,106,0,0.12);
    }

    #clock{ color:var(--muted); font-size:13px; margin-left:8px; }

    /* Error */
    .error{
      background:#fff4f6;
      color:#9b1c1c;
      padding:10px;
      border-radius:8px;
      display:none;
      margin-bottom:12px;
      border:1px solid rgba(155,28,28,0.08);
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(240px,1fr));
      gap:12px;
      margin-top:12px;
    }

    .room{
      background:var(--card-bg);
      border-radius:12px;
      padding:14px;
      box-shadow:0 8px 24px rgba(11,11,11,0.06);
      border:1px solid rgba(11,11,11,0.05);
      transition:0.18s;
      position:relative;
      min-height:120px;
    }

    .room:hover{ transform:translateY(-6px); box-shadow:0 16px 38px rgba(11,11,11,0.07); }

    .room.ongoing{
      border-color:rgba(122,27,27,0.20);
      box-shadow:0 14px 34px rgba(122,27,27,0.10);
    }

    .title{
      font-weight:700;
      font-size:15px;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .status{
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      display:inline-block;
    }

    .free{ background:#f0fff4; color:var(--ok-green); }
    .busy{ background:#fff7f0; color:var(--danger); }

    .short-summary{ margin-top:10px; font-size:13px; color:#333; min-height:36px; }

    .meeting-line{
      font-size:13px;
      color:#444;
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }

    .meeting-title{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:160px;
    }

    .meeting-time{ color:var(--muted); min-width:78px; text-align:right; font-size:12px; }

    .listBtn{
      margin-top:10px;
      display:inline-block;
      background:transparent;
      color:var(--brand-orange);
      padding:6px 8px;
      border-radius:8px;
      text-decoration:none;
      font-weight:700;
      border:1px solid rgba(255,106,0,0.12);
      cursor:pointer;
    }

    .details{ margin-top:10px; display:none; font-size:14px; color:#222; }
    .details[aria-hidden="false"]{ display:block; }

    .meeting{
      padding:8px;
      margin-bottom:8px;
      border-radius:8px;
      background:#fafafa;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
    }

    .badge{
      background:var(--danger);
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      margin-left:6px;
    }

    .meta-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }

    footer{
      margin-top:18px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
    }

    @media (max-width:520px){
      body{ padding:12px; }
      .grid{ grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); }
      .meeting-title{ max-width:120px; }
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="brand">
      <div class="logo">
        <img src="baazlogo.png" class="logo-img" alt="Logo">
      </div>
      <div>
        <h1>Baaz Bike</h1>
        <p>Meeting Rooms Dashboard</p>
      </div>
    </div>

    <div id="controls">
      <button id="bookNow" class="btn">Book Now</button>
      <div id="clock"></div>
    </div>
  </header>

  <div id="error" class="error" role="alert"></div>

  <main>
    <div id="rooms" class="grid" aria-live="polite"></div>
  </main>

  <footer>Baaz Bike <code>@2025</code> Future</footer>

  <script>
  (function(){

    /* ⭐ T CAPITAL AUTO-FIX FOR ALL TURF NAMES ⭐ */
    function formatTurfName(str){
      if(!str) return "";

      let s = String(str).trim();

      // If pattern like turf101 or turf-101 or turf 101
      const m = s.match(/turf[\s\-]*([0-9]+)/i);
      if(m){
        return `Turf - ${m[1]}`;
      }

      // normalize leading turf words without number
      s = s.replace(/^turf[\s\-]*/i, 'Turf - ');

      if(/^Turf\s*-\s*$/i.test(s)) return "Turf";
      if(/^turf/i.test(s)) return 'T' + s.slice(1);
      return s;
    }

    const API_BASE = 'http://192.168.1.41:8000';
    let currentData = [];

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function extractDateField(v){
      if(!v) return '';
      if(typeof v === 'string') return v;
      if(typeof v === 'object') return v.dateTime || v.date || '';
      return '';
    }

    function fmtTime(v){
      if(!v) return '';
      try{
        const d = new Date(v);
        if(isNaN(d)) return v;
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      }catch(e){ return v; }
    }

    function extractOrganizer(o){
      if(!o) return '';
      if(typeof o === 'string') return o;
      if(typeof o === 'object') return o.email || o.displayName || '';
      return '';
    }

    function showError(msg){
      const el = document.getElementById('error');
      if(!msg){ el.style.display='none'; return; }
      el.style.display='block';
      el.textContent = msg;
    }

    /* RENDER ROOMS */
    function renderRooms(data){
      const c = document.getElementById("rooms");
      c.innerHTML = "";

      data.forEach(room=>{
        const idSafe = room.id || room.name || room.calendarId || "";

        const busy = room.status === "busy";
        const meetings = Array.isArray(room.meetings) ? room.meetings : [];
        const topMeetings = meetings.slice(0,2);
        const totalCount = meetings.length || 0;

        const div = document.createElement("div");
        div.className = "room" + (busy ? " ongoing" : "");

        div.innerHTML = `
          <div class="title">
            ${escapeHtml(formatTurfName(room.name || room.displayName || idSafe))}
            ${busy ? '<span class="badge">Ongoing</span>' : ''}
          </div>

          <div>
            <span class="status ${busy ? 'busy':'free'}">
              ${busy ? 'Busy':'Free'}
            </span>
          </div>

          <div class="short-summary">
            ${
              topMeetings.length
                ? topMeetings.map(m=>{
                    const s = extractDateField(m.start);
                    const e = extractDateField(m.end);
                    return `
                      <div class="meeting-line">
                        <span class="meeting-title">${escapeHtml(m.title || 'Meeting')}</span>
                        <span class="meeting-time">${fmtTime(s)} - ${fmtTime(e)}</span>
                      </div>
                    `;
                  }).join('')
                : '<em style="color:var(--muted)">No meetings today</em>'
            }
          </div>

          <button class="listBtn" data-id="${escapeHtml(idSafe)}">
            Show meetings ${ totalCount ? '(' + totalCount + ')' : '' }
          </button>

          <div class="details" id="details-${escapeHtml(idSafe)}" aria-hidden="true"></div>

          <div class="meta-row">
            <div>Organizer: <strong>${escapeHtml(extractOrganizer(meetings[0]?.organizer))}</strong></div>
            <div style="margin-left:auto;color:var(--muted);font-size:12px">${room.lastUpdated||''}</div>
          </div>
        `;

        c.appendChild(div);
      });
    }

    /* FETCH */
    async function fetchRooms(){
      const r = await fetch(`${API_BASE}/api/rooms`);
      return await r.json();
    }

    async function fetchMeetings(roomId){
      const r = await fetch(`${API_BASE}/api/rooms/${encodeURIComponent(roomId)}/meetings-today`);
      return await r.json();
    }

    async function loadData(){
      try{
        const rooms = await fetchRooms();
        const now = new Date();

        const enriched = await Promise.all(rooms.map(async room=>{
          const key = room.calendarId || room.id || room.name;
          let meetings = [];
          try{
            meetings = await fetchMeetings(key);
          }catch(e){
            meetings = [];
          }

          // Current status
          let status = "free";
          if(Array.isArray(meetings) && meetings.some(m=>{
            const s = new Date(extractDateField(m.start));
            const e = new Date(extractDateField(m.end));
            return s && e ? (s <= now && now < e) : false;
          })) status = "busy";

          return {
            id: room.id,
            name: room.name,
            calendarId: key,
            meetings: meetings,
            status: status,
            lastUpdated: new Date().toLocaleTimeString()
          };
        }));

        currentData = enriched;
        renderRooms(currentData);

      }catch(e){
        showError("Failed to load data");
        console.error(e);
      }
    }

    /* Toggle details (show full meetings) */
    document.addEventListener("click", e=>{
      if(e.target.classList.contains("listBtn")){
        const id = e.target.dataset.id;
        const div = document.getElementById(`details-${id}`);
        const open = div.getAttribute("aria-hidden") === "false";
        if(open){
          div.setAttribute("aria-hidden","true");
          div.innerHTML = "";
        } else {
          const room = currentData.find(r=>String(r.calendarId)==String(id) || String(r.id)===String(id) || String(r.name)===String(id));
          if(room && Array.isArray(room.meetings) && room.meetings.length){
            div.innerHTML = room.meetings.map(m=>{
              const s = extractDateField(m.start);
              const e = extractDateField(m.end);
              return `
                <div class="meeting">
                  <strong>${escapeHtml(m.title)}</strong>
                  <div style="font-size:13px;color:#444">
                    ${fmtTime(s)} - ${fmtTime(e)} · ${escapeHtml(extractOrganizer(m.organizer))}
                  </div>
                </div>
              `;
            }).join('');
          } else {
            div.innerHTML = "<em>No meetings</em>";
          }
          div.setAttribute("aria-hidden","false");
        }
      }
    });

    /* Book Now button -> open Google Calendar event creation */
    document.getElementById("bookNow").addEventListener("click", function(){
      window.open("https://calendar.google.com/calendar/u/0/r/eventedit", "_blank");
    });

    /* Clock */
    setInterval(()=>{ document.getElementById("clock").textContent = new Date().toLocaleString(); },1000);

    /* Initial load (no auto refresh) */
    loadData();

  })();
  </script>

</body>
</html>
