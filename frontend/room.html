<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turf — Today's Schedule (TV)</title>
  <style>
    :root {
      --brand-orange: #ffb07a;
      --brand-orange-strong: #ff8f3b;
      --bg: #0f1112;
      --muted: #9ca3af;
      --white: #ffffff;
      --big: clamp(28px, 3.0vw, 48px);
      --medium: clamp(18px, 2.2vw, 32px);
      --small: clamp(12px, 1.2vw, 18px);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    html, body {
      height: 100%;
      margin: 0;
      color: var(--white);
      overflow: hidden;
      background: 
        linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55)),
        url("wall 4.webp");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .wrap {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 18px;
      gap: 12px;
      box-sizing: border-box;
      margin: 0 auto;
      max-width: 1400px;
      width: 100%;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      min-height: 85px;
      padding: 0 18px;
      justify-content: space-between;
      margin-top: 10px;
    }

    .logo {
      width: 100px;
      height: 65px;
      border-radius: 10px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .logo::before {
      content: '';
      position: absolute;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
      border-radius: 50%;
      filter: blur(40px);
      z-index: -1;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .logo::after {
      content: '';
      position: absolute;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.3) 40%, transparent 70%);
      border-radius: 50%;
      filter: blur(60px);
      z-index: -2;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .logo-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: relative;
      z-index: 1;
      filter: 
        drop-shadow(0 0 15px rgba(255,255,255,1)) 
        drop-shadow(0 0 30px rgba(255,255,255,0.8)) 
        drop-shadow(0 0 45px rgba(255,255,255,0.6))
        brightness(1.2)
        contrast(1.1);
    }

    .brand {
      font-size: calc(var(--big) * 1.5);
      font-weight: 900;
      white-space: nowrap;
    }

    .brand-sub {
      font-size: var(--small);
      color: var(--muted);
      margin-top: 4px;
    }

    .header-right {
      margin-left: auto;
      text-align: right;
    }

    #clock {
      font-size: var(--medium);
      font-weight: 700;
      color: #e6e6e6;
    }

    .main {
      display: flex;
      gap: 16px;
      align-items: stretch;
      flex: 1;
      min-height: 0;
    }

    .left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel {
      background: transparent;
      border-radius: 12px;
      padding: 6px;
      overflow: hidden;
    }

    .schedule {
      background: rgba(0, 0, 0, 0.02);
      border-radius: 12px;
      padding: 18px;
      overflow: auto;
      height: calc(100vh - 160px);
    }

    .sched-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.01);
      transition: transform 160ms, background 200ms, color 200ms;
    }

    .sched-item:hover {
      transform: translateY(-3px);
    }

    .sched-item .title {
      font-size: var(--medium);
      font-weight: 800;
      white-space: normal;
      overflow: visible;
      max-width: 100%;
    }

    .sched-item .meta {
      font-size: var(--small);
      color: var(--muted);
      margin-top: 6px;
    }

    .sched-item .time {
      font-weight: 800;
      font-size: var(--small);
      color: #fff;
      text-align: right;
      min-width: 140px;
    }

    .sched-item.ongoing {
      background: linear-gradient(90deg, rgba(255,176,122,0.28), rgba(255,176,122,0.12));
      border: 1px solid rgba(255,140,60,0.18);
      box-shadow: 0 8px 20px rgba(255,140,60,0.06);
      color: #000;
    }

    .sched-item.ongoing .title,
    .sched-item.ongoing .time,
    .sched-item.ongoing .meta {
      color: #000;
    }

    .ongoing-badge {
      display: inline-block;
      font-weight: 900;
      padding: 6px 8px;
      border-radius: 8px;
      background: var(--brand-orange);
      color: #000;
      font-size: 12px;
      margin-left: 8px;
    }

    .error {
      background: #3b0b0b;
      padding: 10px;
      border-radius: 10px;
      color: #ffd6d0;
      display: none;
      font-size: 13px;
    }

    footer {
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      margin-top: 6px;
    }

    @media (max-width: 1000px) {
      .schedule {
        height: calc(100vh - 180px);
      }
      .sched-item .time {
        min-width: 110px;
      }
    }
  </style>
</head>
<body class="hide-cursor">
  <div class="wrap" role="main" aria-live="polite">
    <header>
      <div class="logo">
        <img src="baaz1.png" alt="Logo" style="width:100%; height:100%; object-fit:contain;">
      </div>

      <div>
        <div class="brand"><span id="brandTurfId">—</span></div>
        <div class="brand-sub"></div>
      </div>

      <div class="header-right">
        <div id="clock">—</div>
      </div>
    </header>

    <div id="error" class="error" role="alert" aria-live="assertive"></div>

    <div class="main">
      <div class="left panel">
        <div class="schedule panel" aria-label="Today's schedule">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:820;font-size:var(--medium)">Today's schedule</div>
            <div style="color:var(--muted);font-size:var(--small)" id="totalMeet">0 meetings</div>
          </div>
          <div id="scheduleList" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <footer>Meeting display</footer>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    (function(){
      const ERR_EL = document.getElementById('error');
      const BRAND_TURF_ID = document.getElementById('brandTurfId');
      const SCHEDULE_LIST = document.getElementById('scheduleList');
      const TOTAL_MEET = document.getElementById('totalMeet');
      const CLOCK = document.getElementById('clock');

      let API_BASE = null;
      let roomId = null;
      let resolvedRoom = null;
      let countdownInterval = null;
      const AUTO_REFRESH_MS = 30000;

      function showError(msg){
        if(!msg){ ERR_EL.style.display='none'; ERR_EL.textContent=''; return; }
        ERR_EL.style.display='block'; ERR_EL.textContent = msg; console.warn(msg);
      }

      function escapeHtml(s){
        if(s===undefined||s===null) return '';
        return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      function qParam(name){
        const p = new URLSearchParams(window.location.search);
        return p.get(name);
      }

      function extractDateField(v){
        if(!v) return '';
        if(typeof v === 'string') return v;
        if(typeof v === 'object') return v.dateTime || v.date || '';
        return '';
      }

      function dateFromISOorHM(v){
        if(!v) return null;
        const isoTry = new Date(v);
        if(!isNaN(isoTry) && (typeof v === 'string') && (v.includes('T') || v.includes('+') || v.includes('Z'))) return isoTry;
        const m = (v||'').match(/^(\d{1,2}):(\d{2})$/);
        if(m){ const d = new Date(); d.setHours(Number(m[1]), Number(m[2]), 0, 0); return d; }
        return isoTry;
      }

      function formatNice(d){
        if(!d) return '--:--';
        try{
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }catch(e){
          return '--:--';
        }
      }

      function clearSchedule(){
        SCHEDULE_LIST.innerHTML = '';
        TOTAL_MEET.textContent = '0 meetings';
      }

      function renderSchedule(meetings){
        SCHEDULE_LIST.innerHTML = '';
        if(!Array.isArray(meetings) || meetings.length === 0){
          TOTAL_MEET.textContent = '0 meetings';
          SCHEDULE_LIST.innerHTML = '<div style="color:var(--muted);font-size:var(--small);padding:12px">No meetings today</div>';
          return;
        }

        const norm = meetings.map(m=> {
          const sraw = extractDateField(m.start);
          const eraw = extractDateField(m.end);
          const sdate = dateFromISOorHM(sraw);
          const edate = dateFromISOorHM(eraw);
          return Object.assign({}, m, {start_raw:sraw, end_raw:eraw, startDate:sdate, endDate:edate});
        }).sort((a,b)=> (a.startDate && b.startDate) ? a.startDate - b.startDate : (a.startDate ? -1 : 1));

        norm.forEach(m=>{
          const item = document.createElement('div');
          item.className = 'sched-item';
          const who = m.organizer || '—';
          const startText = formatNice(m.startDate);
          const endText = formatNice(m.endDate);
          const title = escapeHtml(m.title || m.summary || 'Untitled');
          item.innerHTML = `<div style="min-width:0">
              <div class="title">${title}</div>
              <div class="meta">${escapeHtml(who)}</div>
            </div>
            <div style="text-align:right">
              <div class="time">${escapeHtml(startText)} — ${escapeHtml(endText)}</div>
            </div>`;
          SCHEDULE_LIST.appendChild(item);
          m._el = item;
        });

        TOTAL_MEET.textContent = norm.length + ' meetings';

        const now = new Date();
        for(let i=0;i<norm.length;i++){
          const m = norm[i];
          if(m.startDate && m.endDate && m.startDate <= now && now < m.endDate){
            if(m._el){
              m._el.classList.add('ongoing');
              const titleDiv = m._el.querySelector('.title');
              if(titleDiv && !titleDiv.querySelector('.ongoing-badge')){
                const b = document.createElement('span');
                b.className = 'ongoing-badge';
                b.textContent = 'ONGOING';
                titleDiv.appendChild(b);
              }
            }
          }
        }
      }

      async function loadConfig(){
        try{
          const r = await fetch('config.json', {cache:'no-store'});
          if(!r.ok) throw new Error('config.json not found');
          const cfg = await r.json();
          if(!cfg.API_URL) throw new Error('API_URL missing in config.json');
          API_BASE = cfg.API_URL.replace(/\/+$/,'');
        }catch(e){ throw e; }
      }

      async function fetchRoomsList(){
        try{
          const res = await fetch(API_BASE + '/rooms', {cache:'no-store'});
          if(!res.ok) throw new Error('rooms fetch failed: ' + res.status);
          return await res.json();
        }catch(e){ console.warn(e); return null; }
      }

      async function fetchMeetingsForRoom(rid){
        try{
          const res = await fetch(API_BASE + '/rooms/' + encodeURIComponent(rid) + '/meetings-today', {cache:'no-store'});
          if(!res.ok) throw new Error('meetings fetch failed: '+res.status);
          return await res.json();
        }catch(e){ console.warn(e); return null; }
      }

      async function fetchAndRender(){
        showError('');
        if(!resolvedRoom){ showError('Room not resolved'); return; }
        const rid = resolvedRoom.id || resolvedRoom.calendarId || resolvedRoom.name;
        try{
          const meetings = await fetchMeetingsForRoom(rid);
          const meetingsListLocal = Array.isArray(meetings) ? meetings : [];
          renderSchedule(meetingsListLocal);
        }catch(err){
          console.warn('fetchAndRender error', err);
          showError('Failed to fetch schedule — check API. Using API base: ' + (API_BASE || 'unknown') + '. See console for details.');
          clearSchedule();
        }
      }

      function computeTurfHeader(resolvedRoom){
        let rawId = (resolvedRoom.id || resolvedRoom.calendarId || resolvedRoom.name || "").toString().trim();
        let rawName = (resolvedRoom.name || "").toString().trim();

        const idLower = rawId.toLowerCase();
        const nameLower = rawName.toLowerCase();

        let extractedNumber = "";
        const match = idLower.match(/(\d+)/);
        if(match) extractedNumber = match[1];

        if(!extractedNumber){
          let stripped = rawId.replace(/turf/gi,"").replace(/[^0-9a-z]/gi,"").trim();
          const m2 = stripped.match(/(\d+)/);
          if(m2) extractedNumber = m2[1];
          else extractedNumber = stripped || "";
        }

        if(!extractedNumber && rawName){
          let cleanedName = rawName.replace(/^turf\s*[-\s]*/i,"").trim();
          const m3 = cleanedName.match(/(\d+)/);
          if(m3) extractedNumber = m3[1];
          else extractedNumber = cleanedName || "";
        }

        if(!extractedNumber) extractedNumber = rawId || rawName || "—";

        return `Turf - ${extractedNumber}`;
      }

      async function init(){
        try{ await loadConfig(); } catch(e){ showError('Config error: '+e.message); return; }
        roomId = qParam('id') || qParam('room') || null;

        try{
          const rooms = await fetchRoomsList();
          if(!rooms || rooms.length === 0){
            showError('No rooms returned from API');
            BRAND_TURF_ID.textContent = '—';
            clearSchedule();
            return;
          }

          if(roomId){
            const match = rooms.find(r => String(r.id) === String(roomId) || String(r.name) === String(roomId) || String(r.calendarId) === String(roomId));
            resolvedRoom = match || rooms[0];
            if(!match) showError('Requested room not found, showing top room instead.');
          } else {
            resolvedRoom = rooms[0];
          }

          BRAND_TURF_ID.textContent = computeTurfHeader(resolvedRoom);

        }catch(e){
          showError('Failed to fetch rooms list: ' + (e.message || e));
          return;
        }

        await fetchAndRender();
        setInterval(fetchAndRender, AUTO_REFRESH_MS);

        try{
          const parsed = new URL(API_BASE, window.location.origin);
          const socket = io(parsed.origin + '/rooms', { transports:['websocket','polling'] });
          socket.on('connect', ()=> console.log('socket connected'));
          socket.on('room_state', payload => {
            if(!payload) return;
            const rid = resolvedRoom.id || resolvedRoom.name || resolvedRoom.calendarId;
            if(payload.room_id && String(payload.room_id) === String(rid)){
              fetchAndRender();
            }
          });
          socket.on('disconnect', ()=> console.warn('socket disconnected'));
        }catch(e){ console.warn('socket init failed', e); }
      }

      function updateClock(){
        CLOCK.textContent = new Date().toLocaleString();
      }
      setInterval(updateClock, 1000);
      updateClock();

      let cursorTimer = null;
      function resetCursorTimer(){
        document.body.classList.remove('hide-cursor');
        if(cursorTimer) clearTimeout(cursorTimer);
        cursorTimer = setTimeout(()=>document.body.classList.add('hide-cursor'), 3000);
      }
      ['mousemove','keydown','touchstart'].forEach(ev => window.addEventListener(ev, resetCursorTimer));
      resetCursorTimer();

      init();
    })();
  </script>
</body>
</html>