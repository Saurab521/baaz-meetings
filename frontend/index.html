<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baaz Bike â€” Meeting Rooms Dashboard</title>
  <meta name="description" content="Real-time meeting room availability for Baaz Bike - Optimized for 21 rooms">
  <style>
    :root{
      --brand-orange:#ff6a00;
      --muted:#6b7280;
      --card-bg:#fff;
      --ok-green:#065f46;
      --danger:#7a1b1b;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    body{
      margin:0;
      padding:18px;
      background:linear-gradient(180deg,#fff,#fbfbfb);
      color:#0b0b0b;
      -webkit-font-smoothing:antialiased;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }

    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{ width:75px; height:75px; display:flex; align-items:center; justify-content:center; padding:0; }
    .logo-img{ width:100%; height:100%; object-fit:contain; }

    .brand h1{ margin:0; font-size:18px; font-weight:700; }
    .brand p{ margin:0; font-size:12px; color:var(--muted); font-weight:600; }

    #controls{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    .btn{
      background:var(--brand-orange);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 8px 18px rgba(255,106,0,0.12);
      transition:0.2s;
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(255,106,0,0.18); }

    #clock{ color:var(--muted); font-size:13px; margin-left:8px; font-weight:600; }

    .error{
      background:#fff4f6;
      color:#9b1c1c;
      padding:10px;
      border-radius:8px;
      display:none;
      margin-bottom:12px;
      border:1px solid rgba(155,28,28,0.08);
      font-weight:600;
    }

    /* LOADING SPINNER - Shows while data loads */
    .loading{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }
    .spinner{
      border:3px solid rgba(255,106,0,0.1);
      border-top:3px solid var(--brand-orange);
      border-radius:50%;
      width:40px;
      height:40px;
      animation:spin 0.8s linear infinite;
      margin:0 auto 16px;
    }
    @keyframes spin{
      0%{ transform:rotate(0deg); }
      100%{ transform:rotate(360deg); }
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(240px,1fr));
      gap:12px;
      margin-top:12px;
    }

    .room{
      background:var(--card-bg);
      border-radius:12px;
      padding:14px;
      box-shadow:0 8px 24px rgba(11,11,11,0.06);
      border:1px solid rgba(11,11,11,0.05);
      transition:0.18s;
      position:relative;
      min-height:120px;
    }

    .room:hover{ transform:translateY(-6px); box-shadow:0 16px 38px rgba(11,11,11,0.07); }

    .room.ongoing{
      border-color:rgba(122,27,27,0.20);
      box-shadow:0 14px 34px rgba(122,27,27,0.10);
    }

    .title{
      font-weight:700;
      font-size:15px;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .status{
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      display:inline-block;
    }

    .free{ background:#f0fff4; color:var(--ok-green); }
    .busy{ background:#fff7f0; color:var(--danger); }

    .short-summary{ margin-top:10px; font-size:13px; color:#333; min-height:36px; }

    .meeting-line{
      font-size:13px;
      color:#444;
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }

    .meeting-title{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:160px;
    }

    .meeting-time{ color:var(--muted); min-width:78px; text-align:right; font-size:12px; }

    .listBtn{
      margin-top:10px;
      display:inline-block;
      background:transparent;
      color:var(--brand-orange);
      padding:6px 8px;
      border-radius:8px;
      text-decoration:none;
      font-weight:700;
      border:1px solid rgba(255,106,0,0.12);
      cursor:pointer;
      transition:0.2s;
    }
    .listBtn:hover{ background:rgba(255,106,0,0.05); }

    .details{ margin-top:10px; display:none; font-size:14px; color:#222; }
    .details[aria-hidden="false"]{ display:block; }

    .meeting{
      padding:8px;
      margin-bottom:8px;
      border-radius:8px;
      background:#fafafa;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
    }

    .badge{
      background:var(--danger);
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      margin-left:6px;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{ opacity:1; }
      50%{ opacity:0.7; }
    }

    .meta-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }

    footer{
      margin-top:18px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
    }

    /* Performance indicator */
    .perf-indicator{
      position:fixed;
      bottom:10px;
      right:10px;
      background:rgba(255,255,255,0.95);
      padding:8px 12px;
      border-radius:8px;
      font-size:11px;
      color:var(--muted);
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      display:none;
    }

    @media (max-width:520px){
      body{ padding:12px; }
      .grid{ grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); }
      .meeting-title{ max-width:120px; }
    }
  </style>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
</head>

<body>

  <header>
    <div class="brand">
      <div class="logo">
        <img src="baaz1.png" class="logo-img" alt="Baaz Bike Logo">
      </div>
      <div>
        <h1>Baaz Bike</h1>
        <p>Meeting Rooms Dashboard</p>
      </div>
    </div>

    <div id="controls">
      <button id="bookNow" class="btn">Book Now</button>
      <div id="clock"></div>
    </div>
  </header>

  <div id="error" class="error" role="alert"></div>

  <main>
    <div id="rooms" class="grid" aria-live="polite">
      <!-- Loading spinner appears here initially -->
      <div class="loading" style="grid-column:1/-1">
        <div class="spinner"></div>
        <div>Loading meeting rooms...</div>
      </div>
    </div>
  </main>

  <footer>Baaz Bike <code>@2025</code> Future Â· Optimized for 21 Rooms</footer>

  <!-- Performance indicator (hidden by default, shows during dev) -->
  <div id="perfIndicator" class="perf-indicator"></div>

  <script>
  (function(){
    'use strict';

    // ========== CONFIGURATION ==========
    let API_BASE = '/api';
    let currentData = [];
    const AUTO_REFRESH_SECONDS_DEFAULT = 10;
    const SHOW_PERF_INDICATOR = false; // Set to true to see load times

    // ========== HELPER FUNCTIONS ==========
    function sanitizeId(v){ 
      return String(v||'').replace(/[^a-z0-9\-]/gi,'-'); 
    }
    
    function escapeHtml(s){ 
      if(s===undefined||s===null) return ''; 
      return String(s).replace(/[&"'<>]/g, c=>({ 
        '&':'&amp;','"':'&quot;',"'":"&#39;",'<':'&lt;', '>':'&gt;' 
      }[c])); 
    }
    
    function formatTurfName(n){
      if(!n) return '';
      n = String(n).trim().replace(/[-_]+/g,' ').replace(/\s+/g,' ');
      return n.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function toNumberTs(ev, preferStart){
      if(!ev) return null;
      if(preferStart){
        if(ev.start_ts || ev.start_ts === 0) return Number(ev.start_ts);
        if(ev.start){ const d = new Date(ev.start); if(!isNaN(d)) return d.getTime(); }
      } else {
        if(ev.end_ts || ev.end_ts === 0) return Number(ev.end_ts);
        if(ev.end){ const d = new Date(ev.end); if(!isNaN(d)) return d.getTime(); }
      }
      return null;
    }

    function fmtTimeTs(v){
      if(!v) return '';
      try{ 
        const d = new Date(Number(v)); 
        if(isNaN(d)) return ''; 
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); 
      }catch(e){ 
        return ''; 
      }
    }

    function extractOrganizer(o){
      if(!o) return '';
      if(typeof o === 'string') return o;
      if(typeof o === 'object') return o.email || o.displayName || '';
      return '';
    }

    function showError(msg){
      const el = document.getElementById('error');
      if(!msg){ 
        el.style.display='none'; 
        el.textContent=''; 
        return; 
      }
      el.style.display='block';
      el.textContent = msg;
    }

    function showPerf(msg){
      if(!SHOW_PERF_INDICATOR) return;
      const el = document.getElementById('perfIndicator');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function isSameDayTs(ts){
      if(!ts) return false;
      const d = new Date(Number(ts));
      const now = new Date();
      return d.getFullYear() === now.getFullYear() && 
             d.getMonth() === now.getMonth() && 
             d.getDate() === now.getDate();
    }

    function isTodayEvent(ev){
      const s = toNumberTs(ev, true) || (ev.start ? new Date(ev.start).getTime() : null);
      return s && isSameDayTs(s);
    }

    function isOngoingEvent(ev){
      const s = toNumberTs(ev, true) || (ev.start ? new Date(ev.start).getTime() : null);
      const e = toNumberTs(ev, false) || (ev.end ? new Date(ev.end).getTime() : null);
      if(!s || !e) return false;
      const now = Date.now();
      return s <= now && now < e;
    }

    // ========== RENDER FUNCTION ==========
    function renderRooms(data){
      const container = document.getElementById("rooms");
      container.innerHTML = "";

      if(!data || data.length === 0){
        container.innerHTML = '<div class="loading" style="grid-column:1/-1"><em>No rooms configured</em></div>';
        return;
      }

      const now = Date.now();

      data.forEach(room=>{
        const idSafe = room.id || room.name || room.calendarId || "";
        const safeId = sanitizeId(idSafe);

        const state = room.state || {};
        const meetingsAll = Array.isArray(state.all) ? state.all : [];

        const meetingsToday = meetingsAll.filter(isTodayEvent).map(m=>{
          const s = toNumberTs(m, true) || (m.start ? new Date(m.start).getTime() : null);
          const e = toNumberTs(m, false) || (m.end ? new Date(m.end).getTime() : null);
          return Object.assign({}, m, { _start_ts: s, _end_ts: e });
        }).sort((a,b) => (a._start_ts||0) - (b._start_ts||0));

        // Pick top meetings to display (ongoing + next)
        let topMeetings = [];
        const ongoing = meetingsToday.find(isOngoingEvent);
        if(ongoing){
          const remaining = meetingsToday.filter(m => m !== ongoing);
          const next = remaining.find(m => (m._start_ts||0) >= now) || remaining[0] || null;
          topMeetings.push(ongoing);
          if(next) topMeetings.push(next);
        } else {
          const upcoming = meetingsToday.filter(m => (m._start_ts||0) >= now);
          if(upcoming.length >= 2) topMeetings = upcoming.slice(0,2);
          else if(upcoming.length === 1){
            topMeetings = [upcoming[0]];
            const past = meetingsToday.filter(m => (m._start_ts||0) < now);
            if(past.length) topMeetings.push(past[past.length-1]);
          } else {
            const past = meetingsToday.filter(m => (m._start_ts||0) < now);
            topMeetings = past.slice(-2);
          }
        }

        const occupied = !!(state.is_ongoing || state.occupied || ongoing || (state.current && Object.keys(state.current||{}).length));
        const totalCount = meetingsToday.length || 0;

        const div = document.createElement("div");
        div.className = "room" + (occupied ? " ongoing" : "");
        div.innerHTML = `
          <div class="title">
            ${escapeHtml(formatTurfName(room.name || room.displayName || idSafe))}
            ${occupied ? '<span class="badge">Ongoing</span>' : ''}
          </div>

          <div>
            <span class="status ${occupied ? 'busy':'free'}">
              ${occupied ? 'Busy':'Free'}
            </span>
          </div>

          <div class="short-summary">
            ${
              (topMeetings && topMeetings.length)
                ? topMeetings.map(m=>{
                    const s = m._start_ts || m.start || null;
                    const e = m._end_ts || m.end || null;
                    const ongoingMark = isOngoingEvent(m) ? ' <strong style="color:var(--danger);margin-left:6px">ONGOING</strong>' : '';
                    return `
                      <div class="meeting-line">
                        <span class="meeting-title">${escapeHtml(m.title || 'Meeting')}${ongoingMark}</span>
                        <span class="meeting-time">${fmtTimeTs(s)} - ${fmtTimeTs(e)}</span>
                      </div>
                    `;
                  }).join('')
                : '<em style="color:var(--muted)">No meetings today</em>'
            }
          </div>

          <button class="listBtn" data-id="${escapeHtml(idSafe)}" data-safeid="${safeId}">
            Show meetings ${ totalCount ? '(' + totalCount + ')' : '' }
          </button>

          <div class="details" id="details-${safeId}" aria-hidden="true"></div>

          <div class="meta-row">
            <div>Organizer: <strong>${escapeHtml((meetingsToday.find(isOngoingEvent) || meetingsToday[0] || {}).organizer || '')}</strong></div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ========== OPTIMIZED DATA LOADING (BATCH FETCH) ==========
    async function loadDataFast(forceFresh = true){
      const startTime = performance.now();
      console.log('ðŸš€ Loading data (optimized for 21 rooms)...');
      
      try{
        // Step 1: Get list of all rooms (fast - just metadata from Redis)
        const roomsResp = await fetch(`${API_BASE}/rooms/list-with-state`, { cache: "no-store" });
        if(!roomsResp.ok) throw new Error('Failed to fetch rooms list');
        const rooms = await roomsResp.json();
        
        // Step 2: Only show cached data on FIRST load (not on refresh)
        if(!currentData || currentData.length === 0){
          currentData = rooms;
          renderRooms(currentData);
          const loadTime1 = performance.now() - startTime;
          console.log(`âœ“ Initial render: ${loadTime1.toFixed(0)}ms (cached data)`);
        }
        
        // Step 3: ALWAYS fetch FRESH data from Google Calendar
        const roomIds = rooms.map(r => r.id || r.name).filter(Boolean);
        
        if(roomIds.length > 0){
          console.log(`ðŸ“¦ Batch fetching ${roomIds.length} rooms FRESH data...`);
          
          const batchResp = await fetch(`${API_BASE}/rooms/batch-meetings-today`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              room_ids: roomIds,
              force_fresh: forceFresh  // Always get fresh data
            }),
            cache: "no-store"
          });
          
          if(batchResp.ok){
            const batchData = await batchResp.json();
            
            // Step 4: Merge FRESH batch data into rooms
            let updatedCount = 0;
            rooms.forEach(room => {
              const rid = room.id || room.name;
              if(batchData[rid]){
                room.state = room.state || {};
                room.state.all = batchData[rid];
                room.state.last_success = new Date().toISOString();
                updatedCount++;
              }
            });
            
            // Step 5: Update currentData and re-render with FRESH data
            currentData = rooms;
            renderRooms(currentData);
            
            const loadTime2 = performance.now() - startTime;
            console.log(`âœ“ FRESH data loaded: ${loadTime2.toFixed(0)}ms (${updatedCount} rooms updated)`);
            showPerf(`Updated in ${loadTime2.toFixed(0)}ms`);
          } else {
            console.warn('Batch fetch failed, retrying...');
            // Retry once after 2 seconds
            setTimeout(() => loadDataFast(true), 2000);
          }
        }
        
        showError(null);
        
      }catch(e){
        showError("Failed to load meeting data. Retrying...");
        console.error('Load error:', e);
        // Retry after 5 seconds
        setTimeout(() => loadDataFast(true), 5000);
      }
    }

    // ========== TOGGLE MEETING DETAILS ==========
    document.addEventListener("click", async e=>{
      if(e.target.classList.contains("listBtn")){
        const id = e.target.dataset.id;
        const safeId = e.target.dataset.safeid || sanitizeId(id);
        const div = document.getElementById(`details-${safeId}`);
        const open = div.getAttribute("aria-hidden") === "false";
        
        if(open){
          div.setAttribute("aria-hidden","true");
          div.innerHTML = "";
        } else {
          const room = currentData.find(r=>
            String(r.calendarId)==String(id) || 
            String(r.id)===String(id) || 
            String(r.name)===String(id)
          );
          
          let meetings = room && room.state && Array.isArray(room.state.all) 
            ? room.state.all.filter(isTodayEvent) 
            : [];
          
          meetings = (meetings || []).map(m=>{
            const s = toNumberTs(m, true) || (m.start ? new Date(m.start).getTime() : null);
            const e = toNumberTs(m, false) || (m.end ? new Date(m.end).getTime() : null);
            return Object.assign({}, m, { _start_ts: s, _end_ts: e });
          }).sort((a,b)=>(a._start_ts||0) - (b._start_ts||0));

          if(meetings.length){
            div.innerHTML = meetings.map(m=>{
              const ongoingMark = isOngoingEvent(m) 
                ? ' <strong style="color:var(--danger);margin-left:6px">ONGOING</strong>' 
                : '';
              return `
                <div class="meeting">
                  <strong>${escapeHtml(m.title)}</strong>
                  <div style="font-size:13px;color:#444">
                    ${fmtTimeTs(m._start_ts)} - ${fmtTimeTs(m._end_ts)} Â· ${escapeHtml(extractOrganizer(m.organizer))}${ongoingMark}
                  </div>
                </div>
              `;
            }).join('');
          } else {
            div.innerHTML = "<em>No meetings today</em>";
          }
          div.setAttribute("aria-hidden","false");
        }
      }
    });

    // ========== BOOK NOW BUTTON ==========
    document.getElementById("bookNow").addEventListener("click", function(){ 
      window.open("https://calendar.google.com/calendar/u/0/r/eventedit", "_blank"); 
    });

    // ========== CLOCK UPDATE ==========
    function updateClock(){
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleString();
    }
    updateClock();
    setInterval(updateClock, 1000);

    // ========== SOCKET.IO + INITIALIZATION ==========
    (async function init(){
      console.log('ðŸŽ¯ Baaz Bike Meeting Dashboard - Optimized for 21 Rooms');
      
      // Load configuration
      let cfg = {
        API_URL: "/api",
        REFRESH_INTERVAL_SECONDS: AUTO_REFRESH_SECONDS_DEFAULT,
        AUTO_REFRESH: true
      };

      try {
        const resp = await fetch('/config.json', { cache: "no-store" });
        if (resp.ok) {
          const parsed = await resp.json();
          cfg = Object.assign(cfg, parsed);
        }
      }catch(e){
        console.log('No config.json, using defaults');
      }

      API_BASE = (cfg.API_URL && String(cfg.API_URL).trim()) 
        ? cfg.API_URL.trim() 
        : API_BASE;

      // Initialize Socket.IO for real-time updates
      try{
        const parsed = new URL(API_BASE, window.location.origin);
        const socket = io(parsed.origin + '/rooms', { 
          transports:['websocket','polling'] 
        });

        socket.on('connect', ()=> {
          console.log('âœ“ Socket.IO connected:', socket.id);
        });
        
        socket.on('disconnect', ()=> {
          console.warn('âœ— Socket.IO disconnected');
        });

        socket.on('room_state', async payload=>{
          try{
            if(!payload || !payload.room_id) return;
            const rid = String(payload.room_id);
            
            // Update room state in current data
            const idx = (currentData||[]).findIndex(r => 
              String(r.id) === rid || 
              String(r.calendarId) === rid || 
              String(r.name) === rid
            );
            
            if(idx >= 0){
              currentData[idx].state = payload.state || {};
              renderRooms(currentData);
              console.log(`âœ“ Real-time update: ${rid}`);
            }
          }catch(e){ 
            console.warn('room_state handler error:', e); 
          }
        });

        socket.on('rooms_updated', ()=> {
          console.log('âœ“ Rooms updated - reloading FRESH data...');
          if(typeof loadDataFast === 'function') loadDataFast(true);  // Force fresh
        });

      }catch(e){
        console.warn('Socket.IO init failed (will use polling only):', e);
      }

      // Initial fast load (CRITICAL FOR PERFORMANCE)
      await loadDataFast();
      
      // Periodic refresh
      if(cfg.AUTO_REFRESH && Number(cfg.REFRESH_INTERVAL_SECONDS) > 0){
        const intervalMs = Number(cfg.REFRESH_INTERVAL_SECONDS) * 1000;
        console.log(`âœ“ Auto-refresh enabled: every ${cfg.REFRESH_INTERVAL_SECONDS}s`);
        setInterval(loadDataFast, intervalMs);
      }
      
      console.log('âœ“ Dashboard initialized successfully');
    })();

  })();
  </script>

</body>
</html>