<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baaz Bike â€” Meeting Rooms</title>
  <style>
    :root{
      --brand-orange:#ff6a00;
      --muted:#6b7280;
      --card-bg:#fff;
      --ok-green:#065f46;
      --danger:#7a1b1b;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    body{
      margin:0;
      padding:18px;
      background:linear-gradient(180deg,#fff,#fbfbfb);
      color:#0b0b0b;
      -webkit-font-smoothing:antialiased;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }

    /* BRAND GROUP */
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }

   .logo{
     width:75px;
     height:75px;
     display:flex;
     align-items:center;
     justify-content:center;
     overflow:visible;
     border:none !important;
     padding:0;
    }

.logo-img{
  width:100%;
  height:100%;
  object-fit:contain;
}

    .brand h1{ margin:0; font-size:18px; font-weight:700; }
    .brand p{ margin:0; font-size:12px; color:var(--muted); font-weight:600; }

    /* Controls */
    #controls{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    .btn{
      background:var(--brand-orange);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 8px 18px rgba(255,106,0,0.12);
    }

    #clock{ color:var(--muted); font-size:13px; margin-left:8px; }

    .error{
      background:#fff4f6;
      color:#9b1c1c;
      padding:10px;
      border-radius:8px;
      display:none;
      margin-bottom:12px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(240px,1fr));
      gap:12px;
      margin-top:12px;
    }

    .room{
      background:var(--card-bg);
      border-radius:12px;
      padding:14px;
      box-shadow:0 8px 24px rgba(11,11,11,0.06);
      border:1px solid rgba(11,11,11,0.05);
      transition:0.18s;
      position:relative;
      min-height:120px;
    }

    .room.ongoing{
      border-color:rgba(122,27,27,0.20);
    }

    .title{
      font-weight:700;
      font-size:15px;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .status{
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      display:inline-block;
    }

    .free{ background:#f0fff4; color:var(--ok-green); }
    .busy{ background:#fff7f0; color:var(--danger); }

    .short-summary{ margin-top:10px; font-size:13px; color:#333; min-height:36px; }
    .meeting-line{
      font-size:13px;
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }

    .details{ margin-top:10px; display:none; font-size:14px; }
    .details[aria-hidden="false"]{ display:block; }

    footer{
      margin-top:18px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="brand">
      <div class="logo">
        <img src="baaz1.png" class="logo-img" alt="Logo">
      </div>
      <div>
        <h1>Baaz Bike</h1>
        <p>Meeting Rooms Dashboard</p>
      </div>
    </div>

    <div id="controls">
      <button id="bookNow" class="btn">Book Now</button>
      <div id="clock"></div>
    </div>
  </header>

  <div id="error" class="error"></div>

  <main>
    <div id="rooms" class="grid"></div>
  </main>

  <footer>Baaz Bike <code>@2025</code></footer>

  <script>
  (function(){

    function sanitizeId(s){
      return String(s||'').replace(/[^a-zA-Z0-9\-_]/g, '-');
    }

    function formatTurfName(str){
      if(!str) return "";
      let s = String(str).trim();
      const m = s.match(/turf[\s\-]*([0-9]+)/i);
      if(m) return `Turf - ${m[1]}`;
      return s.replace(/^turf[\s\-]*/i, 'Turf - ');
    }

    const API_BASE = '/api';
    let currentData = [];

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    }

    function extractDateField(v){
      if(!v) return '';
      return typeof v === 'object' ? v.dateTime || v.date || '' : v;
    }

    function fmtTime(v){
      if(!v) return '';
      const d = new Date(v);
      if(isNaN(d)) return v;
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:true});
    }

    async function fetchRooms(){
      const r = await fetch(`${API_BASE}/rooms/list-with-state`);
      return await r.json();
    }

    function renderRooms(data){
      const c = document.getElementById("rooms");
      c.innerHTML = "";

      data.forEach(room=>{
        const idSafe = sanitizeId(room.id);
        const busy = room.status === 'busy';
        const meetings = room.meetings || [];
        const top = meetings.slice(0,2);

        const div = document.createElement("div");
        div.className = "room" + (busy ? " ongoing" : "");

        div.innerHTML = `
          <div class="title">
            ${escapeHtml(formatTurfName(room.name))}
            ${busy ? '<span class="badge">Ongoing</span>' : ''}
          </div>

          <div>
            <span class="status ${busy ? 'busy':'free'}">
              ${busy ? 'Busy':'Free'}
            </span>
          </div>

          <div class="short-summary">
            ${
              top.length
              ? top.map(m=>{
                  return `
                    <div class="meeting-line">
                      <span>${escapeHtml(m.title)}</span>
                      <span>${fmtTime(extractDateField(m.start))} - ${fmtTime(extractDateField(m.end))}</span>
                    </div>
                  `;
                }).join('')
              : '<em style="color:var(--muted)">No meetings today</em>'
            }
          </div>
        `;

        c.appendChild(div);
      });
    }

    async function loadData(){
      try{
        const rooms = await fetchRooms();
        currentData = rooms.map(r=>({
          id: r.id,
          name: r.name,
          meetings: r.state?.all || [],
          status: r.state?.occupied ? 'busy':'free'
        }));
        renderRooms(currentData);
      }catch(e){
        console.error(e);
      }
    }

    // Book
    document.getElementById("bookNow").onclick = ()=>window.open("https://calendar.google.com/calendar/u/0/r/eventedit");

    // Clock
    setInterval(()=>{ document.getElementById("clock").textContent = new Date().toLocaleString(); },1000);

    // Initial load + auto reload every 30 seconds
    loadData();
    setInterval(loadData, 30000);

  })();
  </script>

</body>
</html>
