name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy (SSH)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install netcat (for connectivity test)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y netcat-openbsd rsync curl

      - name: SSH connectivity test
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          echo "Testing connection to $SERVER_IP on port ${SERVER_PORT:-22}"
          nc -vz $SERVER_IP ${SERVER_PORT:-22} || echo "Port not reachable (may still work if firewall blocks ping)."

      - name: Deploy using SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 120s
          command_timeout: 10m
          debug: true
          script_stop: true
          script: |
            set -e

            DEPLOY_DIR=/opt/meeting-display

            echo "[1/6] Ensuring project directory exists"
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            echo "[2/6] Cloning or updating repository (robust)"

            # Case 1: already a git repo
            if [ -d .git ]; then
              echo "→ Found .git — updating existing repo"
              git fetch --all --prune
              git reset --hard origin/main

            # Case 2: directory not empty & no .git — clone to temp and sync
            elif [ -n "$(ls -A . 2>/dev/null)" ]; then
              echo "→ Directory is not empty and no .git — cloning in temp directory"
              tmpdir=$(mktemp -d)

              echo "→ Cloning to temp: $tmpdir"
              GIT_TERMINAL_PROMPT=0 git clone https://github.com/${{ github.repository }} "$tmpdir" || {
                echo "git clone to tmp failed";
                exit 1;
              }

              echo "→ Syncing repo into target folder"
              rsync -a --delete "$tmpdir/" .

              rm -rf "$tmpdir"

              echo "→ Initializing git structure"
              git init
              git remote add origin https://github.com/${{ github.repository }} || true
              git fetch origin
              git reset --hard origin/main

            # Case 3: directory empty — normal clone
            else
              echo "→ Directory empty — cloning directly"
              GIT_TERMINAL_PROMPT=0 git clone https://github.com/${{ github.repository }} . || {
                echo "git clone failed";
                exit 1;
              }
            fi

            echo "[3/6] Ensure Docker exists"
            command -v docker || (echo "Docker missing"; exit 1)

            echo "[4/6] Building and deploying via Docker Compose"
            sudo docker compose pull || true
            sudo docker compose build --no-cache
            sudo docker compose up -d --remove-orphans

            echo "[5/6] Cleaning system"
            sudo docker system prune -f || true

            echo "[6/6] Deployment complete!"
